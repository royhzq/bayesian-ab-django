{% extends 'abtest/base.html' %}
{% block header %}
<header style="background-color: #fc8d62">
  <h1>Displaying Version B</h1>
</header>
{% endblock %}
{% block content %}
<h3>You are being served version B of the page undergoing A/B/C testing </h3>
<p>
    This is a demonstration of how Bayesian A/B testing works using Django. This page can be replaced by any View that you may want to test in your application.
</p>

<p>
    If you see this page, an <em>Impression</em> has been registered. You may <a href="/">reload</a> this page 
    to let the algorithm assign you a different (or possibly the same) version.
</p>
<p>
  This version of the page currently has:  
</p>
<ul>
    <li>xx Impressions</li>
    <li>xx Conversions</li>
    <li>0.xx Conversion Rate</li>
</ul>
<p>
    As this is a demonstration of A/B testing. Do take note of the following:    
</p>
<ul>
    <li>
        <strong>Sticky Sessions</strong> is turned off. That means that this test does not remember the previous version that was assigned to your page request, allowing you to possibly see different versions as you refresh the page. By default, sticky sessions is turned on.
    </li>
</ul>
{{ testvar }}

{{ campaign }}
{{ campaign.code }} {{ codetype }}
<p>*************</p>
{% for v in variants %}
    {{ v }}
    <p>*************</p>
{% endfor %}


<p>Session Variables</p>
<p>
    {{ request.session.items }}
</p>
<p>{{ session_key }}</p>

<script>

function getCookie (name) {
  var value = '; ' + document.cookie
  var parts = value.split('; ' + name + '=')
  if (parts.length === 2) {
    return parts
      .pop()
      .split(';')
      .shift()
  }
}

function factorial(num) {
  if(num===0){
    return 1;
  }
  else{
    return num*factorial(num-1);
  }
}
function betaPDF(x, a, b) {
    beta = (factorial(a-1)*factorial(b-1))/factorial(a+b-1)
    return (Math.pow(x, a-1)*Math.pow(1-x, b-1))/beta
}

function submitResponseAB(campaign_code, variant_code, register_impression, register_conversion, params){

  params = typeof params !== 'undefined' ? params : {};
  console.log(campaign_code, variant_code, register_impression, register_conversion, params)
  var xhttp = new XMLHttpRequest()
  xhttp.onreadystatechange = function () {
    if (this.readyState === 4 && this.status === 200) {
      response = JSON.parse(this.response)
      console.log(response)
    }
  }
  xhttp.open('POST', '/api/experiment/response', true)
  xhttp.setRequestHeader('Content-Type', 'application/json')
  xhttp.setRequestHeader('X-CSRFToken', getCookie('csrftoken'))
  xhttp.send(
    JSON.stringify({
      campaign_code : campaign_code,
      variant_code : variant_code,
      register_impression : register_impression,
      register_conversion : register_conversion,
      params : params,
    })
  )
}
console.log('Submitting Response')
submitResponseAB('{{ campaign.code }}', 'B', true, false)
if (Math.random() > (1-0.7)) {
    submitResponseAB('{{ campaign.code }}', 'B', false, true)
}



</script>
{% endblock %}